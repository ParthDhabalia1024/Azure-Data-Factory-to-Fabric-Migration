<#
.SYNOPSIS
    Interactive Azure Data Factory ‚Üí Microsoft Fabric migration tool with logging and safe error handling.
 
.DESCRIPTION
    - Logs into Azure
    - Detects subscription automatically
    - Lets user choose Resource Group, ADF, and Pipeline(s)
    - Migrates selected pipelines to Fabric
    - Handles all ADF name variations and errors gracefully
    - Logs actions and messages to /Logs folder
 
.REQUIREMENTS
    PowerShell 7+
    Modules: Az.Accounts, Az.DataFactory, MigrateFactoryToFabric
#>
 
param(
    [Parameter(Mandatory = $true)]
    [string]$FabricWorkspaceId,
 
    [Parameter(Mandatory = $true)]
    [string]$ResolutionsFile,
 
    [Parameter(Mandatory = $false)]
    [string]$Region = "prod"
)
 
# ----------------------------
# Setup logging
# ----------------------------
$LogFolder = "$PSScriptRoot\Logs"
if (-not (Test-Path $LogFolder)) {
    New-Item -ItemType Directory -Path $LogFolder | Out-Null
}
$LogFile = "$LogFolder\MigrationLog_{0}.txt" -f (Get-Date -Format "yyyyMMdd_HHmmss")
"--- Starting Migration Session ---" | Out-File -FilePath $LogFile
 
function Log($message, $color = "Gray") {
    Write-Host $message -ForegroundColor $color
    Add-Content -Path $LogFile -Value ("[{0}] {1}" -f (Get-Date -Format "HH:mm:ss"), $message)
}
 
# ----------------------------
# Step 1. Login to Azure
# ----------------------------
Log "üîê Logging into Azure..." "Yellow"
try {
    Add-AzAccount | Out-Null
    $context = Get-AzContext
    if (-not $context) { throw "Azure login failed. No context found." }
    $SubscriptionId = $context.Subscription.Id
    Log "üìò Active Subscription: $($context.Subscription.Name) ($SubscriptionId)" "Green"
    Select-AzSubscription -SubscriptionId $SubscriptionId | Out-Null
}
catch {
    Log "‚ùå Azure login failed: $($_.Exception.Message)" "Red"
    Pause
    exit
}
 
# ----------------------------
# Step 2. List Resource Groups
# ----------------------------
Log "`nüì¶ Retrieving resource groups..." "Yellow"
try {
    $resourceGroups = Get-AzResourceGroup | Sort-Object ResourceGroupName
    if (-not $resourceGroups) { throw "No resource groups found in this subscription." }
 
    for ($i = 0; $i -lt $resourceGroups.Count; $i++) {
        Write-Host "[$($i+1)] $($resourceGroups[$i].ResourceGroupName)"
    }
    $rgChoice = Read-Host "Enter the number of the Resource Group"
    $rgIndex = [int]$rgChoice - 1
    if ($rgIndex -lt 0 -or $rgIndex -ge $resourceGroups.Count) { throw "Invalid selection." }
    $ResourceGroupName = $resourceGroups[$rgIndex].ResourceGroupName
    Log "‚úÖ Selected Resource Group: $ResourceGroupName" "Green"
}
catch {
    Log "‚ùå Failed to list or select Resource Group: $($_.Exception.Message)" "Red"
    Pause
    exit
}
 
# ----------------------------
# Step 3. List Azure Data Factories (ADF)
# ----------------------------
Log "`nüè≠ Retrieving Azure Data Factories from '$ResourceGroupName'..." "Yellow"
try {
    $factories = Get-AzDataFactoryV2 -ResourceGroupName $ResourceGroupName -ErrorAction Stop
    if (-not $factories) {
        throw "No Azure Data Factories found in resource group '$ResourceGroupName'."
    }
 
    # Normalize array and resolve name property variations
    if ($factories -isnot [System.Collections.IEnumerable]) {
        $factories = @($factories)
    }
 
    Write-Host "`nSelect a Data Factory to migrate:" -ForegroundColor Cyan
    for ($i = 0; $i -lt $factories.Count; $i++) {
        $factoryName = $factories[$i].DataFactoryName
        if (-not $factoryName) { $factoryName = $factories[$i].Name }
        if (-not $factoryName -and $factories[$i].DataFactory) { $factoryName = $factories[$i].DataFactory.Name }
        if (-not $factoryName) { $factoryName = "UNKNOWN_FACTORY_$i" }
 
        Write-Host "[$($i+1)] $factoryName"
        $factories[$i] | Add-Member -NotePropertyName "ResolvedName" -NotePropertyValue $factoryName -Force
    }
 
    $factoryChoice = Read-Host "Enter the number of the Data Factory"
    $factoryIndex = [int]$factoryChoice - 1
    if ($factoryIndex -lt 0 -or $factoryIndex -ge $factories.Count) { throw "Invalid selection." }
 
    $DataFactoryName = $factories[$factoryIndex].ResolvedName
    if (-not $DataFactoryName) {
        throw "Selected Data Factory has no valid name property. Try updating Az.DataFactory module."
    }
 
    Log "‚úÖ Selected Data Factory: $DataFactoryName" "Green"
}
catch {
    Log "‚ùå Error retrieving Data Factories: $($_.Exception.Message)" "Red"
    Pause
    exit
}
 
# ----------------------------
# Step 4. List pipelines
# ----------------------------
Log "`nüìú Retrieving pipelines from '$DataFactoryName'..." "Yellow"
try {
    $pipelines = Get-AzDataFactoryV2Pipeline -ResourceGroupName $ResourceGroupName -DataFactoryName $DataFactoryName -ErrorAction Stop
    if (-not $pipelines) { throw "No pipelines found in '$DataFactoryName'." }
 
    for ($j = 0; $j -lt $pipelines.Count; $j++) {
        Write-Host "[$($j+1)] $($pipelines[$j].Name)"
    }
    Write-Host "[A] All pipelines" -ForegroundColor Cyan
 
    $pipelineChoice = Read-Host "Enter the number of the pipeline to migrate (or A for all)"
    if ($pipelineChoice -eq "A" -or $pipelineChoice -eq "a") {
        $PipelineNames = $pipelines.Name
        Log "‚úÖ All pipelines selected for migration." "Green"
    }
    else {
        $pipelineIndex = [int]$pipelineChoice - 1
        if ($pipelineIndex -lt 0 -or $pipelineIndex -ge $pipelines.Count) { throw "Invalid pipeline selection." }
        $PipelineNames = @($pipelines[$pipelineIndex].Name)
        Log "‚úÖ Selected pipeline: $($PipelineNames[0])" "Green"
    }
}
catch {
    Log "‚ùå Error retrieving pipelines: $($_.Exception.Message)" "Red"
    Pause
    exit
}
 
# ----------------------------
# Step 5. Tokens
# ----------------------------
Log "`nüîë Retrieving secure tokens..." "Yellow"
try {
    $adfSecureToken = (Get-AzAccessToken -ResourceUrl "https://management.azure.com/").Token
    $fabricSecureToken = (Get-AzAccessToken -ResourceUrl "https://analysis.windows.net/powerbi/api").Token
    Log "‚úÖ Tokens acquired successfully." "Green"
}
catch {
    Log "‚ùå Failed to acquire tokens: $($_.Exception.Message)" "Red"
    Pause
    exit
}
 
# ----------------------------
# Step 6. Validate resolutions file
# ----------------------------
if (-not (Test-Path $ResolutionsFile)) {
    Log "‚ö†Ô∏è Resolutions file not found: $ResolutionsFile" "Red"
    Pause
    exit
}
 
# ----------------------------
# Step 7. Run migration(s)
# ----------------------------
foreach ($PipelineName in $PipelineNames) {
    try {
        Log "`nüöÄ Migrating pipeline '$PipelineName' from ADF '$DataFactoryName'..." "Yellow"
        Import-AdfFactory `
            -SubscriptionId $SubscriptionId `
            -ResourceGroupName $ResourceGroupName `
            -FactoryName $DataFactoryName `
            -PipelineName $PipelineName `
            -AdfToken $adfSecureToken |
        ConvertTo-FabricResources |
        Import-FabricResolutions -ResolutionsFilename $ResolutionsFile |
        Export-FabricResources `
            -Region $Region `
            -Workspace $FabricWorkspaceId `
            -Token $fabricSecureToken
        Log "‚úÖ Migration complete for pipeline: $PipelineName" "Green"
    }
    catch {
        Log "‚ùå Migration failed for pipeline '$PipelineName': $($_.Exception.Message)" "Red"
    }
}
 
# ----------------------------
# Step 8. Wrap up
# ----------------------------
Log "`nüéâ Migration complete! Check your Fabric workspace (ID: $FabricWorkspaceId)." "Green"
Log "Logs saved at: $LogFile" "Gray"
 
Write-Host "`nPress any key to exit..." -ForegroundColor Gray
Pause